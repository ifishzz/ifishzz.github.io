<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		
		<meta name="author" content="ifish">
		
		<meta name="generator" content="Hugo 0.54.0" />
		<title>jxwaf in openresty &middot; if1sh</title>
		<link rel="shortcut icon" href="https://ifishzz.github.io//images/favicon.ico">
		<link rel="stylesheet" href="https://ifishzz.github.io//css/style.css">
		<link rel="stylesheet" href="https://ifishzz.github.io//css/highlight.css">

		
		<link rel="stylesheet" href="https://ifishzz.github.io//css/font-awesome.min.css">
		

		
		<link href="https://ifishzz.github.io/index.xml" rel="alternate" type="application/rss+xml" title="if1sh" />
		

		
	</head>

    <body>
       <nav class="main-nav">
	
	
		<a href='https://ifishzz.github.io/'> <span class="arrow">←</span>Home</a>
	
	<a href='https://ifishzz.github.io//posts'>Archive</a>
	
	<a href='https://ifishzz.github.io//categories'>Cate</a>
	<a href='https://ifishzz.github.io//links'>Link</a>

	<a href='https://ifishzz.github.io//about'>About</a>

	

	
	<a class="cta" href="https://ifishzz.github.io/index.xml">Subscribe</a>
	
</nav>


        <section id="wrapper" class="post">
            <article>
                <header>
                    <h1>
                        jxwaf in openresty
                    </h1>
                    <h2 class="headline">
                    Feb 14, 2019 00:00
                    · 721 words
                    · 2 minute read
                      <span class="tags">
                      
                      
                          
                              <a href="https://ifishzz.github.io//tags/jxwaf">jxwaf</a>
                          
                              <a href="https://ifishzz.github.io//tags/openresty">openresty</a>
                          
                      
                      
                      </span>
                    </h2>
                </header>
                
                  
                    <div id="toc">
                      <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#0x00-安装">0x00 安装</a></li>
<li><a href="#0x01-配置反代">0x01 配置反代</a></li>
<li><a href="#log">log</a></li>
</ul></li>
</ul>
</nav>
                    </div>
                  
                
                <section id="post-body">
                    

<h2 id="0x00-安装">0x00 安装</h2>

<p>$ cd /tmp</p>

<p>$ git clone <a href="https://github.com/jx-sec/jxwaf.git">https://github.com/jx-sec/jxwaf.git</a></p>

<p>$ cd jxwaf</p>

<p>$ sh install_waf.sh</p>

<p>$ 运行后显示如下信息即安装成功:</p>

<p>nginx: the configuration file /opt/jxwaf/nginx/conf/nginx.conf syntax is ok</p>

<p>nginx: configuration file /opt/jxwaf/nginx/conf/nginx.conf test is successful</p>

<p><strong>远程规则:</strong></p>

<p>访问 <a href="http://www.jxwaf.com">http://www.jxwaf.com</a> 并注册账号，在 WAF规则管理-&gt;查看官方规则组 页面按照自身需求加载规则，之后在 WAF规则配置-&gt;WAF全局配置 页面获取 “WAF_API_KEY”</p>

<p>修改/opt/jxwaf/nginx/conf/jxwaf/jxwafconfig.json 中的”waf_api_key”为你自己账号的”WAF_API_KEY”</p>

<p>$ /opt/jxwaf/nginx/sbin/nginx 启动openresty,openresty会在启动或者reload的时候自动到jxwaf管理中心拉取用户配置的最新规则</p>

<p><strong>本地规则:</strong></p>

<p>$ curl &ldquo;<a href="http://update.jxwaf.com/waf/update_global_rule&quot;">http://update.jxwaf.com/waf/update_global_rule&quot;</a> -d &lsquo;api_key=3d96848e-bab2-40b7-8c0b-abac3b613585&rsquo; &gt; /opt/jxwaf/nginx/conf/jxwaf/jxwaf_local_config.json</p>

<p>$ curl &ldquo;<a href="http://update.jxwaf.com/waf/update_rule&quot;">http://update.jxwaf.com/waf/update_rule&quot;</a> -d &lsquo;api_key=3d96848e-bab2-40b7-8c0b-abac3b613585&rsquo; &gt; /opt/jxwaf/nginx/conf/jxwaf/jxwaf_local_base_config.json</p>

<p>$ 修改/opt/jxwaf/nginx/conf/jxwaf/jxwaf_config.json 中的”waf_local”为”true”</p>

<p>$ /opt/jxwaf/nginx/sbin/nginx 启动</p>

<p>$ /opt/jxwaf/nginx/sbin/nginx -s stop 停止</p>

<p>$ /opt/jxwaf/nginx/sbin/nginx -s reload 重启</p>

<p>$ /opt/jxwaf/nginx/sbin/nginx -t 检测</p>

<h2 id="0x01-配置反代">0x01 配置反代</h2>

<p>vi /opt/jxwaf/nginx/conf/nginx.conf</p>

<pre><code>#user  nobody;
worker_processes  auto;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

#pid        logs/nginx.pid;


events {
    worker_connections  1024;
}


http {
    include       mime.types;
    default_type  application/octet-stream;

    #log_format  main  '$remote_addr - $remote_user [$time_local] &quot;$request&quot; '
    #                  '$status $body_bytes_sent &quot;$http_referer&quot; '
    #                  '&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;';

    #access_log  logs/access.log  main;

    sendfile        on;
    #tcp_nopush     on;
	resolver  114.114.114.114;
    #keepalive_timeout  0;
    keepalive_timeout  65;
lua_shared_dict limit_req 100m;
lua_shared_dict limit_req_count 100m;
init_by_lua_file /opt/jxwaf/lualib/resty/jxwaf/init.lua;
init_worker_by_lua_file /opt/jxwaf/lualib/resty/jxwaf/init_worker.lua;
rewrite_by_lua_file /opt/jxwaf/lualib/resty/jxwaf/rewrite.lua;
access_by_lua_file /opt/jxwaf/lualib/resty/jxwaf/access.lua;
header_filter_by_lua_file /opt/jxwaf/lualib/resty/jxwaf/header_filter.lua;
body_filter_by_lua_file /opt/jxwaf/lualib/resty/jxwaf/body_filter.lua;
log_by_lua_file /opt/jxwaf/lualib/resty/jxwaf/log.lua;
    #gzip  on;
	upstream www.jxwaf.com {
#	server 192.168.50.201;
	server 192.168.50.233;
}
lua_code_cache on;
    server {
        listen       80;
        server_name  localhost;

        #charset koi8-r;

        #access_log  logs/host.access.log  main;

        location / {
            #root   html;
           # index  index.html index.htm;
           proxy_pass http://www.jxwaf.com;
        }

        #error_page  404              /404.html;

        # redirect server error pages to the static page /50x.html
        #
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
	 #proxy_pass http://www.jxwaf.com;
        }

        # proxy the PHP scripts to Apache listening on 127.0.0.1:80
        #
        #location ~ \.php$ {
        #    proxy_pass   http://127.0.0.1;
        #}

        # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
        #
        #location ~ \.php$ {
        #    root           html;
        #    fastcgi_pass   127.0.0.1:9000;
        #    fastcgi_index  index.php;
        #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;
        #    include        fastcgi_params;
        #}

        # deny access to .htaccess files, if Apache's document root
        # concurs with nginx's one
        #
        #location ~ /\.ht {
        #    deny  all;
        #}
    }


    # another virtual host using mix of IP-, name-, and port-based configuration
    #
    #server {
    #    listen       8000;
    #    listen       somename:8080;
    #    server_name  somename  alias  another.alias;

    #    location / {
    #        root   html;
    #        index  index.html index.htm;
    #    }
    #}


    # HTTPS server
    #
    #server {
    #    listen       443 ssl;
    #    server_name  localhost;

    #    ssl_certificate      cert.pem;
    #    ssl_certificate_key  cert.key;

    #    ssl_session_cache    shared:SSL:1m;
    #    ssl_session_timeout  5m;

    #    ssl_ciphers  HIGH:!aNULL:!MD5;
    #    ssl_prefer_server_ciphers  on;

    #    location / {
    #        root   html;
    #        index  index.html index.htm;
    #    }
    #}

}
</code></pre>

<h2 id="log">log</h2>

<p>find / -name error.log</p>

<p>/opt/jxwaf/nginx/logs/error.log</p>

<p>还可以直接远程日志打到splunk,作者超细节</p>

                </section>
            </article>

            
                

            

            

            

            <footer id="footer">
    
    
    <p class="small">
        Powered by <a href="http://www.gohugo.io/">Hugo</a> Theme By <a href="https://github.com/ifishzz">ifish</a>
    </p>
</footer>

        </section>

        <script src="https://ifishzz.github.io//js/jquery-3.3.1.min.js"></script>
<script src="https://ifishzz.github.io//js/main.js"></script>
<script src="https://ifishzz.github.io//js/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>




  




    </body>
</html>
